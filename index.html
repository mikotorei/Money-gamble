<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>2å€ or 0ï¼ˆã‚ªãƒ¼ãƒ«ã‚¤ãƒ³ + é‡‘åº« + è¨˜éŒ²/ç«¶èµ°ï¼‰</title>
  <style>
    body { font-family: system-ui, sans-serif; max-width: 820px; margin: 28px auto; padding: 0 14px; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 16px; margin-bottom: 14px; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: end; }
    .stats { display: grid; gap: 6px; }
    .big { font-size: 22px; }
    button { padding: 10px 14px; border-radius: 10px; border: 1px solid #ccc; cursor: pointer; }
    button:disabled { opacity: .5; cursor: not-allowed; }
    input[type="number"], input[type="text"], textarea {
      padding: 10px; border-radius: 10px; border: 1px solid #ccc; font-family: inherit;
    }
    textarea { width: 100%; min-height: 84px; resize: vertical; }
    #log { white-space: pre-wrap; background: #f7f7f7; padding: 12px; border-radius: 10px; border: 1px solid #eee; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border-bottom: 1px solid #eee; padding: 8px 6px; text-align: left; }
    th { font-size: 12px; color: #444; }
    .muted { color: #666; font-size: 12px; }
    .badge { display:inline-block; padding: 2px 8px; border:1px solid #ddd; border-radius: 999px; font-size: 12px; }
  </style>
</head>
<body>
  <h1>50%ã§2å€ / 50%ã§0ï¼ˆã‚ªãƒ¼ãƒ«ã‚¤ãƒ³å›ºå®š + é‡‘åº«ï¼‰</h1>

  <div class="card">
    <div class="row" style="justify-content: space-between; align-items: center;">
      <div>
        <div class="muted">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åï¼ˆå…±æœ‰ã‚³ãƒ¼ãƒ‰ã«å…¥ã‚‹ï¼‰</div>
        <div class="row">
          <input id="playerName" type="text" placeholder="ä¾‹ï¼šsetsuli" style="min-width: 220px;" />
          <button id="saveName">ä¿å­˜</button>
        </div>
      </div>
      <div class="muted">è¨˜éŒ²ã¨ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã¯ã“ã®ç«¯æœ«ã®ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã•ã‚Œã¾ã™</div>
    </div>
  </div>

  <div class="card">
    <div class="stats">
      <div>æ‰‹æŒã¡ï¼š<strong class="big" id="wallet"></strong></div>
      <div>é‡‘åº«ï¼š<strong class="big" id="vault"></strong></div>
      <div>åˆè¨ˆè³‡ç”£ï¼š<strong id="total"></strong></div>
      <div>å‹è² å›æ•°ï¼š<strong id="turn"></strong> / å‹ã¡ï¼š<strong id="wins"></strong> / è² ã‘ï¼š<strong id="losses"></strong></div>
    </div>
  </div>

  <div class="card">
    <div class="row">
      <button id="play">æ‰‹æŒã¡å…¨é¡ã§å‹è² ã™ã‚‹ï¼ˆã‚ªãƒ¼ãƒ«ã‚¤ãƒ³ï¼‰</button>
      <button id="reset">ãƒªã‚»ãƒƒãƒˆ</button>
    </div>
    <p id="result"></p>
  </div>

  <div class="card">
    <h2 style="margin-top:0;">é‡‘åº«ï¼ˆå®‰å…¨ã«é€€é¿ï¼‰</h2>
    <div class="row">
      <input id="depositAmt" type="number" min="1" placeholder="é ã‘ã‚‹é¡ï¼ˆæ‰‹æŒã¡â†’é‡‘åº«ï¼‰" />
      <button id="deposit">é ã‘ã‚‹</button>

      <input id="withdrawAmt" type="number" min="1" placeholder="å¼•ãå‡ºã™é¡ï¼ˆé‡‘åº«â†’æ‰‹æŒã¡ï¼‰" />
      <button id="withdraw">å¼•ãå‡ºã™</button>

      <button id="depositAll">æ‰‹æŒã¡å…¨éƒ¨ã‚’é ã‘ã‚‹</button>
      <button id="withdrawAll">é‡‘åº«å…¨éƒ¨ã‚’å¼•ãå‡ºã™</button>
    </div>
  </div>

  <div class="card">
    <h2 style="margin-top:0;">æœ€é«˜è³‡ç”£ï¼ˆä¿å­˜ï¼‰</h2>
    <div class="row">
      <div class="stats" style="min-width: 320px;">
        <div>æœ€é«˜åˆè¨ˆè³‡ç”£ï¼š<strong class="big" id="bestTotal"></strong> <span class="badge" id="bestLabel"></span></div>
        <div class="muted">æ›´æ–°æ—¥æ™‚ï¼š<span id="bestAt"></span></div>
      </div>
      <div>
        <button id="clearBest">æœ€é«˜è¨˜éŒ²ã‚’æ¶ˆã™</button>
      </div>
    </div>
    <p class="muted">â€» æœ€é«˜åˆè¨ˆè³‡ç”£ = æ‰‹æŒã¡ + é‡‘åº« ã®æœ€å¤§å€¤ã€‚å‹è² ä¸­/é€€é¿å¾Œã‚‚å«ã‚ã¦æ›´æ–°ã•ã‚Œã¾ã™ã€‚</p>
  </div>

  <div class="card">
    <h2 style="margin-top:0;">ä»²é–“å†…ã§ç«¶èµ°ï¼ˆå…±æœ‰ã‚³ãƒ¼ãƒ‰ï¼‰</h2>
    <p class="muted">
      ä»•çµ„ã¿ï¼šå„è‡ªãŒå‡ºã—ãŸã€Œå…±æœ‰ã‚³ãƒ¼ãƒ‰ã€ã‚’ã€ãƒãƒ£ãƒƒãƒˆãªã©ã§äº¤æ›ã—ã¦ã“ã®ãƒšãƒ¼ã‚¸ã«è²¼ã‚‹ã ã‘ã€‚<br>
      ã‚µãƒ¼ãƒãƒ¼ç„¡ã—ãªã®ã§ã€ãƒªãƒ³ã‚¯ã‚’çŸ¥ã£ã¦ã„ã‚‹ä»²é–“åŒå£«ã§æ°—è»½ã«æ¥½ã—ã‚ã¾ã™ã€‚
    </p>

    <div class="row">
      <button id="makeCode">è‡ªåˆ†ã®å…±æœ‰ã‚³ãƒ¼ãƒ‰ã‚’ä½œã‚‹</button>
      <button id="copyCode" disabled>ã‚³ãƒ”ãƒ¼</button>
      <button id="clearBoard">ã“ã®ç«¯æœ«ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’æ¶ˆã™</button>
    </div>

    <div class="muted" style="margin-top:8px;">è‡ªåˆ†ã®å…±æœ‰ã‚³ãƒ¼ãƒ‰ï¼š</div>
    <textarea id="myCode" readonly placeholder="ã“ã“ã«ã‚³ãƒ¼ãƒ‰ãŒå‡ºã¾ã™"></textarea>

    <div class="muted" style="margin-top:12px;">ç›¸æ‰‹ã®ã‚³ãƒ¼ãƒ‰ã‚’è²¼ã£ã¦è¿½åŠ ï¼š</div>
    <div class="row">
      <input id="theirCode" type="text" placeholder="ç›¸æ‰‹ã®å…±æœ‰ã‚³ãƒ¼ãƒ‰ã‚’è²¼ã‚‹" style="flex: 1; min-width: 260px;" />
      <button id="addCode">è¿½åŠ </button>
    </div>

    <h3 style="margin:14px 0 6px;">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆã“ã®ç«¯æœ«ï¼‰</h3>
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>åå‰</th>
          <th>æœ€é«˜åˆè¨ˆè³‡ç”£</th>
          <th>æ›´æ–°æ—¥æ™‚</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="boardBody"></tbody>
    </table>
    <div class="muted">â€» ã‚³ãƒ¼ãƒ‰ã¯è»½ã„æ”¹ã–ã‚“è€æ€§ã®ãƒã‚§ãƒƒã‚¯ä»˜ãï¼ˆå¼·ã„èªè¨¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰ã€‚ä»²é–“å†…ã®éŠã³å‘ã‘ã§ã™ã€‚</div>
  </div>

  <div class="card">
    <h2 style="margin-top:0;">å±¥æ­´</h2>
    <div id="log"></div>
  </div>

  <script>
    // ===== è¨­å®š =====
    const INITIAL_WALLET = 100;
    const INITIAL_VAULT  = 0;

    // ===== localStorage keys =====
    const LS_PLAYER = "don_player_name_v1";
    const LS_BEST   = "don_best_v1";     // { bestTotal:number, bestAt:number, label:string }
    const LS_BOARD  = "don_board_v1";    // array of entries

    // ===== çŠ¶æ…‹ =====
    let wallet = INITIAL_WALLET;
    let vault  = INITIAL_VAULT;
    let turn = 0, wins = 0, losses = 0;

    // ===== è¦ç´  =====
    const walletEl = document.getElementById("wallet");
    const vaultEl  = document.getElementById("vault");
    const totalEl  = document.getElementById("total");
    const turnEl   = document.getElementById("turn");
    const winsEl   = document.getElementById("wins");
    const lossesEl = document.getElementById("losses");

    const resultEl = document.getElementById("result");
    const logEl    = document.getElementById("log");

    const bestTotalEl = document.getElementById("bestTotal");
    const bestAtEl    = document.getElementById("bestAt");
    const bestLabelEl = document.getElementById("bestLabel");

    const playerNameInput = document.getElementById("playerName");

    const myCodeTA = document.getElementById("myCode");
    const copyBtn  = document.getElementById("copyCode");
    const theirCodeInput = document.getElementById("theirCode");
    const boardBody = document.getElementById("boardBody");

    function fmt(n) { return Number(n).toLocaleString(); }
    function now() { return Date.now(); }
    function dt(ts) {
      try { return new Date(ts).toLocaleString(); }
      catch { return ""; }
    }
    function addLog(line) {
      logEl.textContent = (line + "\n") + logEl.textContent;
    }

    // ===== æœ€é«˜è³‡ç”£ =====
    function loadBest() {
      try {
        const raw = localStorage.getItem(LS_BEST);
        if (!raw) return { bestTotal: 0, bestAt: 0, label: "" };
        const obj = JSON.parse(raw);
        if (typeof obj.bestTotal !== "number") return { bestTotal: 0, bestAt: 0, label: "" };
        return obj;
      } catch {
        return { bestTotal: 0, bestAt: 0, label: "" };
      }
    }
    function saveBest(best) {
      localStorage.setItem(LS_BEST, JSON.stringify(best));
    }
    function maybeUpdateBest(reasonLabel) {
      const total = wallet + vault;
      const best = loadBest();
      if (total > (best.bestTotal || 0)) {
        const updated = { bestTotal: total, bestAt: now(), label: reasonLabel || "" };
        saveBest(updated);
        renderBest();
        addLog(`ğŸ† æœ€é«˜è³‡ç”£æ›´æ–°ï¼ total=${fmt(total)}ï¼ˆ${reasonLabel || "æ›´æ–°"}ï¼‰`);
      }
    }
    function renderBest() {
      const best = loadBest();
      bestTotalEl.textContent = fmt(best.bestTotal || 0);
      bestAtEl.textContent = best.bestAt ? dt(best.bestAt) : "â€”";
      bestLabelEl.textContent = best.label ? best.label : "â€”";
    }

    // ===== ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å =====
    function loadPlayerName() {
      return localStorage.getItem(LS_PLAYER) || "";
    }
    function savePlayerName(name) {
      localStorage.setItem(LS_PLAYER, name);
    }

    // ===== å…±æœ‰ã‚³ãƒ¼ãƒ‰ï¼ˆè»½ã„ãƒã‚§ãƒƒã‚¯ä»˜ãï¼‰=====
    // â€»æœ¬æ°—ã®æ”¹ã–ã‚“é˜²æ­¢ã§ã¯ãªã„ã§ã™ã€‚ä»²é–“å†…ã®éŠã³ç”¨ã€‚
    function checksum(str) {
      let h = 0;
      for (let i = 0; i < str.length; i++) {
        h = (h * 31 + str.charCodeAt(i)) >>> 0;
      }
      return h.toString(16);
    }
    function encodePayload(obj) {
      const json = JSON.stringify(obj);
      const sig = checksum(json);
      const pack = JSON.stringify({ json, sig });
      // base64 (URLå®‰å…¨å¯„ã‚Š)
      return btoa(unescape(encodeURIComponent(pack))).replaceAll("=", "").replaceAll("+", "-").replaceAll("/", "_");
    }
    function decodePayload(code) {
      const b64 = code.replaceAll("-", "+").replaceAll("_", "/");
      // ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°å¾©å…ƒ
      const pad = b64.length % 4 ? "=".repeat(4 - (b64.length % 4)) : "";
      const pack = decodeURIComponent(escape(atob(b64 + pad)));
      const { json, sig } = JSON.parse(pack);
      if (checksum(json) !== sig) throw new Error("checksum mismatch");
      return JSON.parse(json);
    }

    // ===== ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆã“ã®ç«¯æœ«ï¼‰=====
    function loadBoard() {
      try {
        const raw = localStorage.getItem(LS_BOARD);
        if (!raw) return [];
        const arr = JSON.parse(raw);
        return Array.isArray(arr) ? arr : [];
      } catch { return []; }
    }
    function saveBoard(arr) {
      localStorage.setItem(LS_BOARD, JSON.stringify(arr));
    }
    function upsertBoardEntry(entry) {
      const board = loadBoard();
      // åŒã˜nameãªã‚‰æœ€é«˜å€¤ãŒé«˜ã„æ–¹ã‚’æ¡ç”¨ï¼ˆåŒå€¤ãªã‚‰æ–°ã—ã„æ–¹ï¼‰
      const idx = board.findIndex(e => e.name === entry.name);
      if (idx >= 0) {
        const cur = board[idx];
        if (entry.bestTotal > cur.bestTotal || (entry.bestTotal === cur.bestTotal && entry.bestAt > cur.bestAt)) {
          board[idx] = entry;
        }
      } else {
        board.push(entry);
      }
      // é™é †ã‚½ãƒ¼ãƒˆ
      board.sort((a,b) => (b.bestTotal - a.bestTotal) || (b.bestAt - a.bestAt));
      saveBoard(board);
      renderBoard();
    }
    function removeBoardName(name) {
      const board = loadBoard().filter(e => e.name !== name);
      saveBoard(board);
      renderBoard();
    }
    function renderBoard() {
      const board = loadBoard();
      const me = loadPlayerName() || "ï¼ˆæœªè¨­å®šï¼‰";
      boardBody.innerHTML = "";
      board.forEach((e, i) => {
        const tr = document.createElement("tr");
        const isMe = (e.name === me);
        tr.innerHTML = `
          <td>${i + 1}</td>
          <td>${isMe ? "ğŸ‘¤ " : ""}${escapeHtml(e.name)}</td>
          <td><strong>${fmt(e.bestTotal)}</strong></td>
          <td>${e.bestAt ? dt(e.bestAt) : "â€”"}</td>
          <td><button data-del="${escapeHtmlAttr(e.name)}">å‰Šé™¤</button></td>
        `;
        boardBody.appendChild(tr);
      });

      // å‰Šé™¤ãƒœã‚¿ãƒ³
      boardBody.querySelectorAll("button[data-del]").forEach(btn => {
        btn.addEventListener("click", () => removeBoardName(btn.getAttribute("data-del")));
      });
    }

    function escapeHtml(s) {
      return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#39;");
    }
    function escapeHtmlAttr(s) {
      // å±æ€§ç”¨ã«æœ€ä½é™
      return String(s).replaceAll('"',"&quot;");
    }

    // ===== ç”»é¢æ›´æ–° =====
    function render() {
      walletEl.textContent = fmt(wallet);
      vaultEl.textContent  = fmt(vault);
      totalEl.textContent  = fmt(wallet + vault);
      turnEl.textContent   = String(turn);
      winsEl.textContent   = String(wins);
      lossesEl.textContent = String(losses);

      document.getElementById("play").disabled = (wallet <= 0);

      // æœ€é«˜è³‡ç”£ãƒã‚§ãƒƒã‚¯ï¼ˆè¡¨ç¤ºæ›´æ–°ã¯ maybeUpdateBest å†…ã§ã‚„ã‚‹ï¼‰
      // ã“ã“ã§ã¯ã€Œå˜ã«çŠ¶æ…‹ãŒå¤‰ã‚ã£ãŸã‚‰ã€è¿½å¾“ã•ã›ãŸã„ã®ã§ãƒ©ãƒ™ãƒ«ç„¡ã—ã§ã¯æ›´æ–°ã—ãªã„
    }

    // ===== å‹è² ï¼ˆã‚ªãƒ¼ãƒ«ã‚¤ãƒ³ï¼‰=====
    document.getElementById("play").addEventListener("click", () => {
      if (wallet <= 0) return;

      turn++;
      const bet = wallet;
      wallet = 0;

      const win = Math.random() < 0.5;

      if (win) {
        wins++;
        wallet = bet * 2;
        resultEl.textContent = `#${turn}: âœ… å‹ã¡ï¼ ${fmt(bet)} â†’ ${fmt(wallet)}`;
        addLog(`#${turn}: âœ… å‹ã¡  wallet=${fmt(wallet)}  vault=${fmt(vault)}`);
        maybeUpdateBest("å‹è² ã§æ›´æ–°");
      } else {
        losses++;
        wallet = 0;
        resultEl.textContent = `#${turn}: âŒ è² ã‘â€¦ ${fmt(bet)} â†’ 0`;
        addLog(`#${turn}: âŒ è² ã‘  wallet=0  vault=${fmt(vault)}`);
      }

      render();
    });

    // ===== é‡‘åº«æ“ä½œ =====
    document.getElementById("deposit").addEventListener("click", () => {
      const amt = Math.floor(Number(document.getElementById("depositAmt").value));
      if (!amt || amt <= 0) { resultEl.textContent = "é ã‘ã‚‹é¡ã‚’1ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ã­ã€‚"; return; }
      if (amt > wallet) { resultEl.textContent = "æ‰‹æŒã¡ãŒè¶³ã‚Šãªã„ã‚ˆã€‚"; return; }

      wallet -= amt;
      vault  += amt;
      resultEl.textContent = `ğŸ¦ é‡‘åº«ã« ${fmt(amt)} é ã‘ãŸ`;
      addLog(`ğŸ¦ é ã‘å…¥ã‚Œ amt=${fmt(amt)}  wallet=${fmt(wallet)}  vault=${fmt(vault)}`);
      document.getElementById("depositAmt").value = "";
      maybeUpdateBest("é€€é¿ã§æ›´æ–°");
      render();
    });

    document.getElementById("withdraw").addEventListener("click", () => {
      const amt = Math.floor(Number(document.getElementById("withdrawAmt").value));
      if (!amt || amt <= 0) { resultEl.textContent = "å¼•ãå‡ºã™é¡ã‚’1ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ã­ã€‚"; return; }
      if (amt > vault) { resultEl.textContent = "é‡‘åº«ãŒè¶³ã‚Šãªã„ã‚ˆã€‚"; return; }

      vault  -= amt;
      wallet += amt;
      resultEl.textContent = `ğŸ¦ é‡‘åº«ã‹ã‚‰ ${fmt(amt)} å¼•ãå‡ºã—ãŸ`;
      addLog(`ğŸ¦ å¼•ãå‡ºã— amt=${fmt(amt)}  wallet=${fmt(wallet)}  vault=${fmt(vault)}`);
      document.getElementById("withdrawAmt").value = "";
      render();
    });

    document.getElementById("depositAll").addEventListener("click", () => {
      if (wallet <= 0) { resultEl.textContent = "æ‰‹æŒã¡ãŒ0ã ã‚ˆã€‚"; return; }
      const amt = wallet;
      wallet = 0;
      vault += amt;
      resultEl.textContent = `ğŸ¦ æ‰‹æŒã¡å…¨éƒ¨ï¼ˆ${fmt(amt)}ï¼‰ã‚’é‡‘åº«ã¸`;
      addLog(`ğŸ¦ å…¨é¡é ã‘ amt=${fmt(amt)}  wallet=${fmt(wallet)}  vault=${fmt(vault)}`);
      maybeUpdateBest("é€€é¿ã§æ›´æ–°");
      render();
    });

    document.getElementById("withdrawAll").addEventListener("click", () => {
      if (vault <= 0) { resultEl.textContent = "é‡‘åº«ãŒ0ã ã‚ˆã€‚"; return; }
      const amt = vault;
      vault = 0;
      wallet += amt;
      resultEl.textContent = `ğŸ¦ é‡‘åº«å…¨éƒ¨ï¼ˆ${fmt(amt)}ï¼‰ã‚’æ‰‹æŒã¡ã¸`;
      addLog(`ğŸ¦ å…¨é¡å¼•å‡º amt=${fmt(amt)}  wallet=${fmt(wallet)}  vault=${fmt(vault)}`);
      render();
    });

    // ===== ãƒªã‚»ãƒƒãƒˆ =====
    document.getElementById("reset").addEventListener("click", () => {
      wallet = INITIAL_WALLET;
      vault  = INITIAL_VAULT;
      turn = 0; wins = 0; losses = 0;
      resultEl.textContent = "";
      logEl.textContent = "";
      render();
    });

    // ===== æœ€é«˜è¨˜éŒ²æ“ä½œ =====
    document.getElementById("clearBest").addEventListener("click", () => {
      localStorage.removeItem(LS_BEST);
      renderBest();
      addLog("ğŸ—‘ï¸ æœ€é«˜è³‡ç”£ã‚’å‰Šé™¤");
    });

    // ===== åå‰ä¿å­˜ =====
    document.getElementById("saveName").addEventListener("click", () => {
      const name = (playerNameInput.value || "").trim();
      savePlayerName(name);
      addLog(`ğŸ‘¤ åå‰ã‚’ä¿å­˜ï¼š${name || "ï¼ˆæœªè¨­å®šï¼‰"}`);
      renderBoard(); // ğŸ‘¤è¡¨ç¤ºæ›´æ–°
    });

    // ===== å…±æœ‰ã‚³ãƒ¼ãƒ‰ä½œæˆ =====
    document.getElementById("makeCode").addEventListener("click", () => {
      const name = (loadPlayerName() || "").trim() || "åç„¡ã—";
      const best = loadBest();
      const payload = {
        v: 1,
        name,
        bestTotal: Number(best.bestTotal || 0),
        bestAt: Number(best.bestAt || 0),
      };
      const code = encodePayload(payload);
      myCodeTA.value = code;
      copyBtn.disabled = !code;
      addLog(`ğŸ”— å…±æœ‰ã‚³ãƒ¼ãƒ‰ç”Ÿæˆï¼š${name} / ${fmt(payload.bestTotal)}`);
    });

    // ã‚³ãƒ”ãƒ¼
    document.getElementById("copyCode").addEventListener("click", async () => {
      const code = myCodeTA.value.trim();
      if (!code) return;
      try {
        await navigator.clipboard.writeText(code);
        addLog("ğŸ“‹ å…±æœ‰ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼ã—ãŸ");
      } catch {
        // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ãŒä½¿ãˆãªã„å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        myCodeTA.focus();
        myCodeTA.select();
        document.execCommand("copy");
        addLog("ğŸ“‹ å…±æœ‰ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼ã—ãŸï¼ˆäº’æ›ãƒ¢ãƒ¼ãƒ‰ï¼‰");
      }
    });

    // ç›¸æ‰‹ã‚³ãƒ¼ãƒ‰è¿½åŠ 
    document.getElementById("addCode").addEventListener("click", () => {
      const code = (theirCodeInput.value || "").trim();
      if (!code) { resultEl.textContent = "ç›¸æ‰‹ã®å…±æœ‰ã‚³ãƒ¼ãƒ‰ã‚’è²¼ã£ã¦ã­ã€‚"; return; }
      try {
        const p = decodePayload(code);
        if (!p || p.v !== 1) throw new Error("bad version");
        if (typeof p.name !== "string" || typeof p.bestTotal !== "number") throw new Error("bad payload");

        const entry = {
          name: (p.name || "åç„¡ã—").slice(0, 24),
          bestTotal: Math.floor(p.bestTotal),
          bestAt: Math.floor(p.bestAt || 0),
        };
        upsertBoardEntry(entry);
        addLog(`ğŸ å‚åŠ ï¼š${entry.name} / ${fmt(entry.bestTotal)}`);
        theirCodeInput.value = "";
      } catch (e) {
        resultEl.textContent = "ã‚³ãƒ¼ãƒ‰ãŒæ­£ã—ããªã„ã‹ã€å£Šã‚Œã¦ã„ã¾ã™ã€‚";
        addLog(`âš ï¸ ã‚³ãƒ¼ãƒ‰è¿½åŠ å¤±æ•—ï¼š${String(e && e.message ? e.message : e)}`);
      }
    });

    // ãƒ©ãƒ³ã‚­ãƒ³ã‚°å‰Šé™¤
    document.getElementById("clearBoard").addEventListener("click", () => {
      localStorage.removeItem(LS_BOARD);
      renderBoard();
      addLog("ğŸ—‘ï¸ ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’å‰Šé™¤ï¼ˆã“ã®ç«¯æœ«ï¼‰");
    });

    // ===== åˆæœŸåŒ– =====
    playerNameInput.value = loadPlayerName();
    render();
    renderBest();
    renderBoard();

    // è‡ªåˆ†ã‚‚ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«è¼‰ã›ãŸã„å ´åˆï¼šæœ€é«˜è¨˜éŒ²ãŒã‚ã‚‹ãªã‚‰è‡ªå‹•ã§è¿½åŠ ï¼ˆä»»æ„ï¼‰
    // ä»²é–“å†…ã®è¦‹æ „ãˆãŒè‰¯ã„ã®ã§ONã«ã—ã¦ã‚ã‚Šã¾ã™
    (function autoAddMeToBoard() {
      const name = (loadPlayerName() || "").trim();
      const best = loadBest();
      if (!name || !best.bestTotal) return;
      upsertBoardEntry({ name, bestTotal: best.bestTotal, bestAt: best.bestAt || 0 });
    })();
  </script>
</body>
</html>
